# 模拟经营游戏工程化通识 (Simulation / Tycoon Architecture)

> 适用于《Factorio》、《RimWorld》或《SimCity》类游戏的开发。
> 核心挑战不在于渲染，而在于**如何在每秒 60 帧内模拟 10 万个实体的交互**。

## 🏗️ 1. 核心架构：Chunked Grid System (分块网格系统)
不要试图用一个巨大的 `Tile[10000][10000]` 数组存储世界。
- **Chunk (区块)**: 将世界切割为 16x16 或 32x32 的小块。
    - **内存优势**: 只有玩家探索到的区域才分配内存（稀疏矩阵）。
    - **渲染优势**: 每个 Chunk 作为一个 DrawCall 批处理单元。
    - **逻辑优势**: 只有“活跃区块”内的机器才运行逻辑，远处的冻结。
- **Layers (分层)**:
    - 地面层 (Terrain): 草地、水域 (只读静态数据)。
    - 建筑层 (Buildings): 机器、墙壁 (实体引用)。
    - 物流层 (Logistics): 传送带、电线、水管 (图结构)。

## ⚙️ 2. 流水线与经济 (The Flow & Graph)
模拟游戏的核心是**资源流转**。
- **Push vs Pull**:
    - **传送带 (Push)**: 上游机器主动把物品“推”给下游。适合实体化的物流。
    - **电网/水管 (Graph)**: 不要模拟每个电子的移动。将相连的电线视为一个**连通分量 (Connected Component)**。
        - 整个电网只是一个数字：`TotalSupply - TotalDemand`。
        - 只有当电网断裂或连接时，才重新计算图的连通性 (Rebuild Graph)。
- **脏标记 (Dirty Flags)**:
    - 既然工厂没有变化，就不要每帧重新遍历电网。只有玩家建造/拆除时，才标记 `isGraphDirty = true`。

## ⏩ 3. 仿真循环：The Deterministic Tick (确定性 Tick)
模拟游戏必须支持“3倍速”。
- **Logic vs Render**:
    - **Logic Tick**: 固定 60次/秒 (或者更低，如 Factorio 的 60 UPS)。负责处理产出、移动。
    - **Render Frame**: 显卡能跑多快跑多快。负责插值绘制位置。
- **Time Slicing (时间切片)**:
    - 如果有 10,000 个村民在寻路，不要在这一帧全算完。
    - 每帧只计算 100 个，将负载分摊到 100 帧里 (Load Balancing)。

## ✅ DOS (必须做的事)
1.  **使用定点数 (Fixed Point Math)**:
    - 使用 `int64` 存储资源。采用“毫”作为单位 (Precision = 1000)，如 1 个铁板 = 1000 units。
    - 所有的逻辑计算（生产、消耗、拆分）必须在整数域完成，仅在 UI 显示层转换为小数。
2.  **缓存路径 (Path Caching)**:
    - A* 寻路极慢。如果是长距离运输，计算一次后缓存路径。建立“路网” (Flow Field) 供大量单位共用。
3.  **数据局部性 (Data Locality)**:
    - 把所有的 `ConveyorBelt` 放在一个连续数组里遍历，而不是散落在堆内存中。这对 CPU 缓存极其友好 (SoA layout)。

## ❌ DON'TS (绝对禁止的事)
1.  **🚫 禁止用浮点数存资源 (No Floats for Resources)**:
    - 严禁使用 `float32/64` 存储核心物资数量（如库存、伤害、产量）。
    - 浮点数的精度漂移（如 0.1 + 0.2 != 0.3）会导致“幽灵资源”产生或消失，彻底破坏经济系统的守恒定律。
2.  **🚫 禁止由 Entity 自己 Update**:
    - 经典的 OOP 陷阱：`foreach (e in entities) e.Update()`。这会导致函数调用开销巨大。
    - 正确做法 (System): `ConveyorSystem.UpdateAll(belts)`。
3.  **🚫 禁止在 Tick 中进行 IO**:
    - 严禁在模拟循环里打印日志或读写文件。模拟速度会直接被磁盘 IO 拖垮。
4.  **🚫 禁止依赖渲染状态**:
    - 即使我不渲染这个物体（在屏幕外），它的逻辑（如生产铁板）也必须继续运行。逻辑层绝不能引用 `Sprite.X`。

## 🐜 4. 视觉：繁忙感 (The "Anthill" Factor)
模拟游戏必须让玩家觉得“这就是个活的世界”。
- **微动画 (Micro-Animations)**:
    - 机器工作时，齿轮必须转，活塞必须动。
    - 即使没有实际产出，闲置动画 (Idle) 也是必须的。
- **信息可视化 (Overlay)**:
    - 按下 Alt 键，显示所有机器的效率条、物流方向箭头。
    - 这种“透视眼”功能是硬核玩家的最爱。
- **声音层级**:
    - 离得近的机器声音大，离得远的被低通滤波 (Low-pass filter) 或直接剔除。
    - 几百个机器同时工作时，合成一个“工厂白噪音”背景音，而不是播放几百个音效。
