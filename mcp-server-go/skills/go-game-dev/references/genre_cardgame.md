# 卡牌游戏工程化通识 (Card Game Architecture Manifesto)

> 本文总结了从《炉石传说》到《杀戮尖塔》等顶级 CCG 的核心工程智慧。它是关于**如何管理复杂性**的白皮书，而非简单的代码片段库。

## 🏛️ 1. 核心架构哲学：Tag-Based Entity System (标签驱动实体系统)
卡牌游戏最大的工程陷阱是尝试用面向对象 (OOP) 来模拟卡牌。
- **错误的做法**: 创建 `Minion` 类，继承自 `Card`，然后 `FireMinion` 继承自 `Minion`。当你要实现“沉默”逻辑时，你会发现必须去修改父类的代码，最终导致继承地狱。
- **正确的做法 (Hearthstone 模式)**: **一切皆实体，唯有标签异**。
    - **Entity (实体)**: 仅仅是一个 ID 和一个 `Map<Tag, Value>`。
    - **Tag (标签)**: 描述了所有属性。`COST=3`, `ATK=4`, `TAUNT=1`, `ZONE=HAND`。
    - **Buff 也是实体**: 一个 Buff 只是依附于主实体的另一个 Tag 集合（修改值）。
    - **逻辑即查询**: 所谓的“攻击”，只是查找 `ATK` 标签的值；所谓的“沉默”，只是暂时忽略依附实体的 Modifier 标签。

## ⚡ 2. 状态同步机制：Power History (算力历史)
卡牌游戏不是即时发生的。它是一个**严格有序的事件队列**。
- **The Block (结算块)**: 玩家的每一个动作（如“打出炎爆术”）开启一个新的 `Block`。
- **The Queue (后果队列)**: 炎爆术造成伤害 -> 触发目标受伤逻辑 -> 触发“苦痛侍僧”抽牌 -> 触发“爆牌”逻辑。这一切都是**递归**压入队列的。
- **死相检查 (Death Processing)**: 只有在一个最外层的 `Block` 彻底结束时，系统才会检查所有 `HEALTH <= 0` 的实体，并在下一个 Block 中处理死亡逻辑（触发亡语）。
    - *这就是为什么在炉石里，你的随从降到0血不会立刻消失，直到法术彻底结算完毕。*

## ✅ DOS (必须做的事)
1.  **逻辑显示分离 (Logic/View Separation)**:
    - 确保逻辑层（数据）的运算能瞬间完成 (0ms) 并生成完整的 `PowerHistory` 事件列表。
    - 表现层（UI）应作为一个纯粹的“状态机播放器”，根据事件列表依次播放抽牌、飞弹、爆炸等动画。
2.  **数据驱动效果 (Data-Driven Effects)**:
    - 所有的卡牌效果应定义在 JSON/Lua 脚本中（如 `OP="DEAL_DAMAGE", TARGET="ALL_ENEMY"`）。
    - 这种解耦允许策划通过热修（Hotfix）快速调整数值平衡，无需重新编译客户端。
3.  **确定性随机 (Deterministic RNG)**:
    - 整个游戏的状态必须能通过单一的 `Seed` 完美重现。这对于实现“录像回放”、“断线重连”以及自动化回归测试至关重要。

## ❌ DON'TS (绝对禁止的事)
1.  **🚫 禁止 UI 阻塞逻辑**:
    - 永远不要让 UI 动画（如“飞向手牌”的 2 秒）阻塞核心逻辑线程。逻辑状态变更必须早于视觉表现。
2.  **🚫 禁止硬编码卡牌逻辑**:
    - 严禁在 Go/C# 代码中写死 `if card.ID == "Fireball" { dealDamage(6) }`。这会导致代码库随卡牌数量膨胀而不可维护。
3.  **🚫 禁止在逻辑代码里写 `Sleep()`**:
    - 永远不要为了“等动画播完”而在逻辑线程里 `Sleep`。这会导致无法实现“快进”功能，也无法进行后台 AI 训练。
4.  **🚫 禁止 UI 状态污染游戏状**:
    - “卡牌正在拖拽中”是纯粹的 UI 状态，不应写入 `GameState`。逻辑层只关心 `ZONE` 及其变化。
5.  **🚫 禁止直接修改属性**:
    - 永远不要直接写 `Hero.Health -= 5`。
    - 必须通过 `CreateDamageTask(Source, Target, 5)`。因为伤害可能会被“圣盾”抵消，或被“复仇”增益。直接修改属性意味着你跳过了所有的 Hook 系统。

## 🎨 3. 让游戏“好玩”的物理细节 (Juice)
为什么有些卡牌游戏像 PPT，有些像玩具？区别在于**物理感**。
- **依据速度的倾斜 (Velocity Tilt)**: 拖拽卡牌时，根据鼠标移动速度计算卡牌的 Z 轴旋转。移动越快，卡牌越“飘”。
- **贝塞尔轨迹 (Bezier Trails)**: 没有任何物体是走直线的。抽牌、发牌、攻击，全部使用二次或三次贝塞尔曲线。
- **落地反馈 (Impact)**: 当一张高费卡牌（Tag: COST > 7）落地时，摄像机必须震动（Screen Shake），且产生的烟尘粒子应与卡牌权重成正比。
